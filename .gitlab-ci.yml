default:
  image: docker.sift.net/jharwell/rcsw/ubuntu-22.04:latest

# If all tests pass, deploy.
stages:
  - build-and-test
  - package-and-deploy

################################################################################
# Job to build and run tests
################################################################################
build-and-test:
  tags:
    - docker
  stage: build-and-test
  only:
    - master
    - devel

  script:
    - git submodule set-url libra ../libra.git
    - git submodule sync --recursive
    - git submodule foreach --recursive git fetch
    - git submodule update --init

    - mkdir -p build && cd build

    - cmake
      -DCMAKE_INSTALL_PREFIX=$HOME/.local
      -DCMAKE_BUILD_TYPE=DEV
      -DLIBRA_TESTS=yes
      -DLIBRA_ER=ALL
      ..

    - make build-and-test

################################################################################
# Jobs to build and upload packages
################################################################################
package-and-deploy:
  stage:
    package-and-deploy

  tags:
    - docker

  only:
    - master
    - devel

  script:
    - git submodule set-url libra ../libra.git
    - git submodule sync --recursive
    - git submodule foreach --recursive git fetch
    - git submodule update --init

    - mkdir -p build && cd build

    - cmake
      -DCMAKE_INSTALL_PREFIX=$HOME/.local
      -DCMAKE_BUILD_TYPE=DEV
      -DLIBRA_TESTS=yes
      -DLIBRA_ER=ALL
      ..

    - JOBS=$(nproc)
    - make -j${JOBS}
    - make package

    # Metadata for packaging
    - VERSION_MAJOR=$(sed -nE 's/.*PROJECT_VERSION_MAJOR ([0-9]+).*/\1/p' ../cmake/project-local.cmake)
    - VERSION_MINOR=$(sed -nE 's/.*PROJECT_VERSION_MINOR ([0-9]+).*/\1/p' ../cmake/project-local.cmake)
    - VERSION_PATCH=$(sed -nE 's/.*PROJECT_VERSION_PATCH ([0-9]+).*/\1/p' ../cmake/project-local.cmake)
    - PACKAGE_VERSION=$VERSION_MAJOR.$VERSION_MINOR.$VERSION_PATCH
    - RCSW_DEB_PACKAGE=$(ls *.deb)
    - RCSW_TGZ_PACKAGE=$(ls *.tar.gz)
    - BETA_TAG_VERSION=${PACKAGE_VERSION}.beta
    - BETA_TAG_MESSAGE="Development release ${BETA_TAG_VERSION}"

    - PACKAGE_REGISTRY_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/rcsw/${PACKAGE_VERSION}"

    # Upload packages
    - |
        curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file ${RCSW_DEB_PACKAGE} ${PACKAGE_REGISTRY_URL}/${RCSW_DEB_PACKAGE}
    - |
        curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file ${RCSW_TGZ_PACKAGE} ${PACKAGE_REGISTRY_URL}/${RCSW_TGZ_PACKAGE}

    # Push tag
    - git config --global user.email "${GITLAB_USER_EMAIL}"
    - git config --global user.name "${GITLAB_USER_NAME}"
    - git remote set-url origin https://oauth2:${JHARWELL_CI_TOKEN}@git.sift.net/${CI_PROJECT_PATH}
    - git tag ${BETA_TAG_VERSION} -m "${BETA_TAG_MESSAGE}"
    - git push -o ci.skip origin ${BETA_TAG_VERSION} # don't trigger another run

    # Create release
    - curl --location --output /usr/local/bin/release-cli "https://gitlab.com/api/v4/projects/gitlab-org%2Frelease-cli/packages/generic/release-cli/latest/release-cli-linux-amd64"
    - chmod +x /usr/local/bin/release-cli
    - release-cli
      create
      --name ${BETA_TAG_VERSION}
      --tag-name ${BETA_TAG_VERSION}
      --description "${BETA_TAG_MESSAGE}"
      --assets-link "{\"name\":\"${RCSW_TGZ_PACKAGE}\",\"url\":\"${PACKAGE_REGISTRY_URL}/${RCSW_TGZ_PACKAGE}\"}"
      --assets-link "{\"name\":\"${RCSW_DEB_PACKAGE}\",\"url\":\"${PACKAGE_REGISTRY_URL}/${RCSW_DEB_PACKAGE}\"}"

################################################################################
# Job to build documentation
################################################################################
pages:
  stage: package-and-deploy
  tags:
    - docker

  only:
    - master
    - devel

  script:
    - git submodule set-url libra ../libra.git
    - git submodule sync --recursive
    - git submodule foreach --recursive git fetch
    - git submodule update --init

    - mkdir -p build && cd build

    - cmake
      -DCMAKE_INSTALL_PREFIX=$HOME/.local
      -DCMAKE_BUILD_TYPE=DEV
      ..
    - make apidoc

    - cd ..
    - export PATH=$PATH:$HOME/.local/bin
    - cd docs && make html && cd ..
    - cp -r docs/_build/html/ ./public/

  artifacts:
    paths:
      - public
